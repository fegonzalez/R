<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN"
    "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
      xmlns:dc="http://purl.org/dc/elements/1.1/"
      xmlns:foaf="http://xmlns.com/foaf/0.1/">
  
  <head>
    
    
      
        <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
      
      
      <title>
        Cookbook for R Â» 
        Plotting means and error bars (ggplot2)
      </title>
      
      
        
        <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,400,600" media="screen, projection" />
        <link rel="stylesheet" type="text/css" href="../media/css/mystyle.css" media="screen, projection" />
      
      
      
      
    
  </head>
  
  <body >
    
      
      <div id="header">
        
          <div id="wiki_name">
          
            Cookbook for R
          
          </div>
           
            
  
    <ol id="breadcrumbs">
      
        <li class="crumb-0 not-last">
          
            <a href="../index.html">index</a>
          
        </li>
      
        <li class="crumb-1 not-last">
          
            <a href="../Graphs.html">Graphs</a>
          
        </li>
      
        <li class="crumb-2 last">
          
            Plotting_means_and_error_bars_(ggplot2)
          
        </li>
      
    </ol> <!-- ol#breadcrumbs -->
  

          
        
      </div>
      
      <div id="content">
        
        
        
        <h1 id="plotting-means-and-error-bars-ggplot2">Plotting means and error bars (ggplot2)</h1>
<div class="toc"><span class="toctitle">Table of contents</span><ul>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#plotting-means-and-error-bars-ggplot2">Plotting means and error bars (ggplot2)</a><ul>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#problem">Problem</a></li>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#solution">Solution</a><ul>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#sample-data">Sample data</a></li>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#line-graphs">Line graphs</a></li>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#bar-graphs">Bar graphs</a></li>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#error-bars-for-within-subjects-variables">Error bars for within-subjects variables</a><ul>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#one-within-subjects-variable">One within-subjects variable</a></li>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#understanding-within-subjects-error-bars">Understanding within-subjects error bars</a></li>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#two-within-subjects-variables">Two within-subjects variables</a></li>
</ul>
</li>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#note-about-normed-means">Note about normed means</a></li>
<li><a href="Plotting_means_and_error_bars_(ggplot2).html#helper-functions">Helper functions</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p><strong>This page was recently updated to reflect changes in the new version of ggplot2, 0.9.3. See <a href="http://www.cookbook-r.com/Graphs/Basics/Installing_and_using_packages">Installing and using packages</a> to make sure you have the latest version of ggplot2.</strong></p>
<h2 id="problem">Problem</h2>
<p>You want to plot means and error bars for a dataset.</p>
<h2 id="solution">Solution</h2>
<p>To make graphs with ggplot2, the data must be in a data frame, and in "long" (as opposed to wide) format. If your data needs to be restructured, see <a href="../Manipulating_data/Converting_data_between_wide_and_long_format.html">this page</a> for more information.</p>
<h3 id="sample-data">Sample data</h3>
<p>The examples below will the <code>ToothGrowth</code> dataset. Note that <code>dose</code> is a numeric column here; in some situations it may be useful to convert it to a factor.</p>
<div class="codehilite"><pre>df <span class="o">&lt;-</span> ToothGrowth
<span class="c1">#  len supp dose</span>
<span class="c1">#  4.2   VC  0.5</span>
<span class="c1"># 11.5   VC  0.5</span>
<span class="c1">#  ...</span>
<span class="c1"># 29.4   OJ    2</span>
<span class="c1"># 23.0   OJ    2</span>

<span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
</pre></div>


<p>First, it is necessary to summarize the data. This can be done in a number of ways, as described on <a href="../Manipulating_data/Summarizing_data.html">this page</a>. In this case, we'll use the <code>summarySE()</code> function defined on that page, and also at the <a href="Plotting_means_and_error_bars_(ggplot2).html#Helper functions">bottom</a> of this page. (The code for the <code>summarySE</code> function must be entered before it is called here).</p>
<div class="codehilite"><pre><span class="c1"># summarySE provides the standard deviation, standard error of the mean, and a (default 95%) confidence interval</span>
dfc <span class="o">&lt;-</span> summarySE<span class="p">(</span>df<span class="p">,</span> measurevar<span class="o">=</span><span class="s">&quot;len&quot;</span><span class="p">,</span> groupvars<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;supp&quot;</span><span class="p">,</span><span class="s">&quot;dose&quot;</span><span class="p">))</span>
<span class="c1"># supp dose  N   len       sd        se       ci</span>
<span class="c1">#   OJ  0.5 10 13.23 4.459709 1.4102837 3.190283</span>
<span class="c1">#   OJ  1.0 10 22.70 3.910953 1.2367520 2.797727</span>
<span class="c1">#   OJ  2.0 10 26.06 2.655058 0.8396031 1.899314</span>
<span class="c1">#   VC  0.5 10  7.98 2.746634 0.8685620 1.964824</span>
<span class="c1">#   VC  1.0 10 16.77 2.515309 0.7954104 1.799343</span>
<span class="c1">#   VC  2.0 10 26.14 4.797731 1.5171757 3.432090</span>
</pre></div>


<h3 id="line-graphs">Line graphs</h3>
<p>After the data is summarized, we can make the graph. These are basic line and point graph with error bars representing either the standard error of the mean, or 95% confidence interval.</p>
<div class="codehilite"><pre><span class="c1"># Standard error of the mean</span>
ggplot<span class="p">(</span>dfc<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>dose<span class="p">,</span> y<span class="o">=</span>len<span class="p">,</span> colour<span class="o">=</span>supp<span class="p">))</span> <span class="o">+</span> 
    geom_errorbar<span class="p">(</span>aes<span class="p">(</span>ymin<span class="o">=</span>len<span class="o">-</span>se<span class="p">,</span> ymax<span class="o">=</span>len<span class="o">+</span>se<span class="p">),</span> width<span class="o">=</span><span class="m">.1</span><span class="p">)</span> <span class="o">+</span>
    geom_line<span class="p">()</span> <span class="o">+</span>
    geom_point<span class="p">()</span>


<span class="c1"># The errorbars overlapped, so use position_dodge to move them horizontally</span>
pd <span class="o">&lt;-</span> position_dodge<span class="p">(</span><span class="m">.1</span><span class="p">)</span> <span class="c1"># move them .05 to the left and right</span>

ggplot<span class="p">(</span>dfc<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>dose<span class="p">,</span> y<span class="o">=</span>len<span class="p">,</span> colour<span class="o">=</span>supp<span class="p">))</span> <span class="o">+</span> 
    geom_errorbar<span class="p">(</span>aes<span class="p">(</span>ymin<span class="o">=</span>len<span class="o">-</span>se<span class="p">,</span> ymax<span class="o">=</span>len<span class="o">+</span>se<span class="p">),</span> width<span class="o">=</span><span class="m">.1</span><span class="p">,</span> position<span class="o">=</span>pd<span class="p">)</span> <span class="o">+</span>
    geom_line<span class="p">(</span>position<span class="o">=</span>pd<span class="p">)</span> <span class="o">+</span>
    geom_point<span class="p">(</span>position<span class="o">=</span>pd<span class="p">)</span>


<span class="c1"># Use 95% confidence interval instead of SEM</span>
ggplot<span class="p">(</span>dfc<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>dose<span class="p">,</span> y<span class="o">=</span>len<span class="p">,</span> colour<span class="o">=</span>supp<span class="p">))</span> <span class="o">+</span> 
    geom_errorbar<span class="p">(</span>aes<span class="p">(</span>ymin<span class="o">=</span>len<span class="o">-</span>ci<span class="p">,</span> ymax<span class="o">=</span>len<span class="o">+</span>ci<span class="p">),</span> width<span class="o">=</span><span class="m">.1</span><span class="p">,</span> position<span class="o">=</span>pd<span class="p">)</span> <span class="o">+</span>
    geom_line<span class="p">(</span>position<span class="o">=</span>pd<span class="p">)</span> <span class="o">+</span>
    geom_point<span class="p">(</span>position<span class="o">=</span>pd<span class="p">)</span>

<span class="c1"># Black error bars - notice the mapping of &#39;group=supp&#39; -- without it, the error</span>
<span class="c1"># bars won&#39;t be dodged!</span>
ggplot<span class="p">(</span>dfc<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>dose<span class="p">,</span> y<span class="o">=</span>len<span class="p">,</span> colour<span class="o">=</span>supp<span class="p">,</span> group<span class="o">=</span>supp<span class="p">))</span> <span class="o">+</span> 
    geom_errorbar<span class="p">(</span>aes<span class="p">(</span>ymin<span class="o">=</span>len<span class="o">-</span>ci<span class="p">,</span> ymax<span class="o">=</span>len<span class="o">+</span>ci<span class="p">),</span> colour<span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span> width<span class="o">=</span><span class="m">.1</span><span class="p">,</span> position<span class="o">=</span>pd<span class="p">)</span> <span class="o">+</span>
    geom_line<span class="p">(</span>position<span class="o">=</span>pd<span class="p">)</span> <span class="o">+</span>
    geom_point<span class="p">(</span>position<span class="o">=</span>pd<span class="p">,</span> size<span class="o">=</span><span class="m">3</span><span class="p">)</span>
</pre></div>


<p><img alt="" src="Plotting_means_and_error_bars_(ggplot2)/line.png" />
<img alt="" src="Plotting_means_and_error_bars_(ggplot2)/line-dodge.png" />
<img alt="" src="Plotting_means_and_error_bars_(ggplot2)/line-dodge-ci.png" />
<img alt="" src="Plotting_means_and_error_bars_(ggplot2)/line-dodge-black.png" /></p>
<p>A finished graph with error bars representing the standard error of the mean might look like this. The points are drawn last so that the white fill goes on top of the lines and error bars.</p>
<div class="codehilite"><pre>ggplot<span class="p">(</span>dfc<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>dose<span class="p">,</span> y<span class="o">=</span>len<span class="p">,</span> colour<span class="o">=</span>supp<span class="p">,</span> group<span class="o">=</span>supp<span class="p">))</span> <span class="o">+</span> 
    geom_errorbar<span class="p">(</span>aes<span class="p">(</span>ymin<span class="o">=</span>len<span class="o">-</span>se<span class="p">,</span> ymax<span class="o">=</span>len<span class="o">+</span>se<span class="p">),</span> colour<span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span> width<span class="o">=</span><span class="m">.1</span><span class="p">,</span> position<span class="o">=</span>pd<span class="p">)</span> <span class="o">+</span>
    geom_line<span class="p">(</span>position<span class="o">=</span>pd<span class="p">)</span> <span class="o">+</span>
    geom_point<span class="p">(</span>position<span class="o">=</span>pd<span class="p">,</span> size<span class="o">=</span><span class="m">3</span><span class="p">,</span> shape<span class="o">=</span><span class="m">21</span><span class="p">,</span> fill<span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="c1"># 21 is filled circle</span>
    xlab<span class="p">(</span><span class="s">&quot;Dose (mg)&quot;</span><span class="p">)</span> <span class="o">+</span>
    ylab<span class="p">(</span><span class="s">&quot;Tooth length&quot;</span><span class="p">)</span> <span class="o">+</span>
    scale_colour_hue<span class="p">(</span>name<span class="o">=</span><span class="s">&quot;Supplement type&quot;</span><span class="p">,</span> <span class="c1"># Legend label, use darker colors</span>
                     breaks<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;OJ&quot;</span><span class="p">,</span> <span class="s">&quot;VC&quot;</span><span class="p">),</span>
                     labels<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;Orange juice&quot;</span><span class="p">,</span> <span class="s">&quot;Ascorbic acid&quot;</span><span class="p">),</span>
                     l<span class="o">=</span><span class="m">40</span><span class="p">)</span> <span class="o">+</span>                  <span class="c1"># Use darker colors, lightness=40</span>
    ggtitle<span class="p">(</span><span class="s">&quot;The Effect of Vitamin C on\nTooth Growth in Guinea Pigs&quot;</span><span class="p">)</span> <span class="o">+</span>
    scale_y_continuous<span class="p">(</span>limits<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="kp">max</span><span class="p">(</span>dfc<span class="o">$</span>len <span class="o">+</span> dfc<span class="o">$</span>se<span class="p">)),</span>    <span class="c1"># Set y range</span>
                       breaks<span class="o">=</span><span class="m">0</span><span class="o">:</span><span class="m">20</span><span class="o">*</span><span class="m">4</span><span class="p">)</span> <span class="o">+</span>                       <span class="c1"># Set tick every 4</span>
    theme_bw<span class="p">()</span> <span class="o">+</span>
    theme<span class="p">(</span>legend.justification<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> legend.position<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">))</span> <span class="c1"># Position legend in bottom right</span>
</pre></div>


<p><img alt="" src="Plotting_means_and_error_bars_(ggplot2)/line-final.png" /></p>
<h3 id="bar-graphs">Bar graphs</h3>
<p>The procedure is similar for bar graphs. Note that <code>dfc$size</code> must be a factor. If it is a numeric vector, then it will not work.</p>
<div class="codehilite"><pre><span class="c1"># Use dose as a factor rather than numeric</span>
dfc2 <span class="o">&lt;-</span> dfc
dfc2<span class="o">$</span>dose <span class="o">&lt;-</span> <span class="kp">factor</span><span class="p">(</span>dfc2<span class="o">$</span>dose<span class="p">)</span>

<span class="c1"># Error bars represent standard error of the mean</span>
ggplot<span class="p">(</span>dfc2<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>dose<span class="p">,</span> y<span class="o">=</span>len<span class="p">,</span> fill<span class="o">=</span>supp<span class="p">))</span> <span class="o">+</span> 
    geom_bar<span class="p">(</span>position<span class="o">=</span>position_dodge<span class="p">(),</span> stat<span class="o">=</span><span class="s">&quot;identity&quot;</span><span class="p">)</span> <span class="o">+</span>
    geom_errorbar<span class="p">(</span>aes<span class="p">(</span>ymin<span class="o">=</span>len<span class="o">-</span>se<span class="p">,</span> ymax<span class="o">=</span>len<span class="o">+</span>se<span class="p">),</span>
                  width<span class="o">=</span><span class="m">.2</span><span class="p">,</span>                    <span class="c1"># Width of the error bars</span>
                  position<span class="o">=</span>position_dodge<span class="p">(</span><span class="m">.9</span><span class="p">))</span>


<span class="c1"># Use 95% confidence intervals instead of SEM</span>
ggplot<span class="p">(</span>dfc2<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>dose<span class="p">,</span> y<span class="o">=</span>len<span class="p">,</span> fill<span class="o">=</span>supp<span class="p">))</span> <span class="o">+</span> 
    geom_bar<span class="p">(</span>position<span class="o">=</span>position_dodge<span class="p">(),</span> stat<span class="o">=</span><span class="s">&quot;identity&quot;</span><span class="p">)</span> <span class="o">+</span>
    geom_errorbar<span class="p">(</span>aes<span class="p">(</span>ymin<span class="o">=</span>len<span class="o">-</span>ci<span class="p">,</span> ymax<span class="o">=</span>len<span class="o">+</span>ci<span class="p">),</span>
                  width<span class="o">=</span><span class="m">.2</span><span class="p">,</span>                    <span class="c1"># Width of the error bars</span>
                  position<span class="o">=</span>position_dodge<span class="p">(</span><span class="m">.9</span><span class="p">))</span>
</pre></div>


<p><img alt="" src="Plotting_means_and_error_bars_(ggplot2)/bar.png" />
<img alt="" src="Plotting_means_and_error_bars_(ggplot2)/bar-ci.png" /></p>
<p>A finished graph might look like this.</p>
<div class="codehilite"><pre>ggplot<span class="p">(</span>dfc2<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>dose<span class="p">,</span> y<span class="o">=</span>len<span class="p">,</span> fill<span class="o">=</span>supp<span class="p">))</span> <span class="o">+</span> 
    geom_bar<span class="p">(</span>position<span class="o">=</span>position_dodge<span class="p">(),</span> stat<span class="o">=</span><span class="s">&quot;identity&quot;</span><span class="p">,</span>
             colour<span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span> <span class="c1"># Use black outlines,</span>
             size<span class="o">=</span><span class="m">.3</span><span class="p">)</span> <span class="o">+</span>      <span class="c1"># Thinner lines</span>
    geom_errorbar<span class="p">(</span>aes<span class="p">(</span>ymin<span class="o">=</span>len<span class="o">-</span>se<span class="p">,</span> ymax<span class="o">=</span>len<span class="o">+</span>se<span class="p">),</span>
                  size<span class="o">=</span><span class="m">.3</span><span class="p">,</span>    <span class="c1"># Thinner lines</span>
                  width<span class="o">=</span><span class="m">.2</span><span class="p">,</span>
                  position<span class="o">=</span>position_dodge<span class="p">(</span><span class="m">.9</span><span class="p">))</span> <span class="o">+</span>
    xlab<span class="p">(</span><span class="s">&quot;Dose (mg)&quot;</span><span class="p">)</span> <span class="o">+</span>
    ylab<span class="p">(</span><span class="s">&quot;Tooth length&quot;</span><span class="p">)</span> <span class="o">+</span>
    scale_fill_hue<span class="p">(</span>name<span class="o">=</span><span class="s">&quot;Supplement type&quot;</span><span class="p">,</span> <span class="c1"># Legend label, use darker colors</span>
                   breaks<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;OJ&quot;</span><span class="p">,</span> <span class="s">&quot;VC&quot;</span><span class="p">),</span>
                   labels<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;Orange juice&quot;</span><span class="p">,</span> <span class="s">&quot;Ascorbic acid&quot;</span><span class="p">))</span> <span class="o">+</span>
    ggtitle<span class="p">(</span><span class="s">&quot;The Effect of Vitamin C on\nTooth Growth in Guinea Pigs&quot;</span><span class="p">)</span> <span class="o">+</span>
    scale_y_continuous<span class="p">(</span>breaks<span class="o">=</span><span class="m">0</span><span class="o">:</span><span class="m">20</span><span class="o">*</span><span class="m">4</span><span class="p">)</span> <span class="o">+</span>
    theme_bw<span class="p">()</span>
</pre></div>


<p><img alt="" src="Plotting_means_and_error_bars_(ggplot2)/bar-final.png" /></p>
<h3 id="error-bars-for-within-subjects-variables">Error bars for within-subjects variables</h3>
<p>When all variables are between-subjects, it is straightforward to plot standard error or confidence intervals. However, when there are within-subjects variables (repeated measures), plotting the standard error or regular confidence intervals may be misleading for making inferences about differences between conditions.</p>
<p>The method below is from <a href="http://tqmp.org/Content/vol04-2/p061/p061.html">Morey (2008)</a>, which is a correction to <a href="http://tqmp.org/Content/vol01-1/p042/p042.html">Cousineau (2005)</a>, which in turn is meant to be a simpler method of that in <a href="http://www.springerlink.com/content/n2r2t04244246k68/">Loftus and Masson (1994)</a>. See these papers for a more detailed treatment of the issues involved in error bars with within-subjects variables.</p>
<h4 id="one-within-subjects-variable">One within-subjects variable</h4>
<p>Here is a data set (from Morey 2008) with one within-subjects variable: pre/post-test.</p>
<div class="codehilite"><pre>dfw <span class="o">&lt;-</span> read.table<span class="p">(</span>header<span class="o">=</span><span class="bp">T</span><span class="p">,</span> text<span class="o">=</span><span class="s">&#39;</span>
<span class="s"> subject pretest posttest</span>
<span class="s">       1    59.4     64.5</span>
<span class="s">       2    46.4     52.4</span>
<span class="s">       3    46.0     49.7</span>
<span class="s">       4    49.0     48.7</span>
<span class="s">       5    32.5     37.4</span>
<span class="s">       6    45.2     49.5</span>
<span class="s">       7    60.3     59.9</span>
<span class="s">       8    54.3     54.1</span>
<span class="s">       9    45.4     49.6</span>
<span class="s">      10    38.9     48.5</span>
<span class="s"> &#39;</span><span class="p">)</span>

<span class="c1"># Treat subject ID as a factor</span>
dfw<span class="o">$</span>subject <span class="o">&lt;-</span> <span class="kp">factor</span><span class="p">(</span>dfw<span class="o">$</span>subject<span class="p">)</span>
</pre></div>


<p>The first step is to convert it to long format. See <a href="../Manipulating_data/Converting_data_between_wide_and_long_format.html">this page</a> for more information about the conversion.</p>
<div class="codehilite"><pre><span class="c1"># Convert to long format</span>
<span class="kn">library</span><span class="p">(</span>reshape2<span class="p">)</span>
dfw.long <span class="o">&lt;-</span> melt<span class="p">(</span>dfw<span class="p">,</span>
                 id.vars <span class="o">=</span> <span class="s">&quot;subject&quot;</span><span class="p">,</span>
                 measure.vars <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;pretest&quot;</span><span class="p">,</span><span class="s">&quot;posttest&quot;</span><span class="p">),</span>
                 variable.name <span class="o">=</span> <span class="s">&quot;condition&quot;</span><span class="p">)</span>
<span class="c1"># subject condition value</span>
<span class="c1">#       1   pretest  59.4</span>
<span class="c1">#       2   pretest  46.4</span>
<span class="c1">#       3   pretest  46.0</span>
<span class="c1">#       4   pretest  49.0</span>
<span class="c1">#       5   pretest  32.5</span>
<span class="c1">#       6   pretest  45.2</span>
<span class="c1">#       7   pretest  60.3</span>
<span class="c1">#       8   pretest  54.3</span>
<span class="c1">#       9   pretest  45.4</span>
<span class="c1">#      10   pretest  38.9</span>
<span class="c1">#       1  posttest  64.5</span>
<span class="c1">#       2  posttest  52.4</span>
<span class="c1">#       3  posttest  49.7</span>
<span class="c1">#       4  posttest  48.7</span>
<span class="c1">#       5  posttest  37.4</span>
<span class="c1">#       6  posttest  49.5</span>
<span class="c1">#       7  posttest  59.9</span>
<span class="c1">#       8  posttest  54.1</span>
<span class="c1">#       9  posttest  49.6</span>
<span class="c1">#      10  posttest  48.5</span>
</pre></div>


<p>Collapse the data using <code>summarySEwithin</code> (defined at the <a href="Plotting_means_and_error_bars_(ggplot2).html#Helper functions">bottom</a> of this page; both of the helper functions below must be entered before the function is called here).</p>
<div class="codehilite"><pre>dfwc <span class="o">&lt;-</span> summarySEwithin<span class="p">(</span>dfw.long<span class="p">,</span> measurevar<span class="o">=</span><span class="s">&quot;value&quot;</span><span class="p">,</span> withinvars<span class="o">=</span><span class="s">&quot;condition&quot;</span><span class="p">,</span>
                        idvar<span class="o">=</span><span class="s">&quot;subject&quot;</span><span class="p">,</span> na.rm<span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> conf.interval<span class="o">=</span><span class="m">.95</span><span class="p">)</span>
<span class="c1"># condition  N value value_norm       sd        se       ci</span>
<span class="c1">#  posttest 10 51.43      51.43 2.262361 0.7154214 1.618396</span>
<span class="c1">#   pretest 10 47.74      47.74 2.262361 0.7154214 1.618396</span>

<span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
<span class="c1"># Make the graph with the 95% confidence interval</span>
ggplot<span class="p">(</span>dfwc<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>condition<span class="p">,</span> y<span class="o">=</span>value<span class="p">,</span> group<span class="o">=</span><span class="m">1</span><span class="p">))</span> <span class="o">+</span>
    geom_line<span class="p">()</span> <span class="o">+</span>
    geom_errorbar<span class="p">(</span>width<span class="o">=</span><span class="m">.1</span><span class="p">,</span> aes<span class="p">(</span>ymin<span class="o">=</span>value<span class="o">-</span>ci<span class="p">,</span> ymax<span class="o">=</span>value<span class="o">+</span>ci<span class="p">))</span> <span class="o">+</span>
    geom_point<span class="p">(</span>shape<span class="o">=</span><span class="m">21</span><span class="p">,</span> size<span class="o">=</span><span class="m">3</span><span class="p">,</span> fill<span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)</span> <span class="o">+</span>
    ylim<span class="p">(</span><span class="m">40</span><span class="p">,</span><span class="m">60</span><span class="p">)</span>
</pre></div>


<p><img alt="" src="Plotting_means_and_error_bars_(ggplot2)/within-line.png" /></p>
<p>The <code>value</code> and <code>value_norm</code> columns represent the un-normed and normed means. See the section below on normed means for more information.</p>
<h4 id="understanding-within-subjects-error-bars">Understanding within-subjects error bars</h4>
<p>This section explains how the within-subjects error bar values are calculated. The steps here are for explanation purposes only; they are not necessary for <strong>making</strong> the error bars.</p>
<p>The graph of individual data shows that there is a consistent trend for the within-subjects variable <code>condition</code>, but this would not necessarily be revealed by taking the regular standard errors (or confidence intervals) for each group. The method in Morey (2008) and Cousineau (2005) essentially normalizes the data to remove the between-subject variability and calculates the variance from this normalized data.</p>
<div class="codehilite"><pre><span class="c1"># Use a consistent y range</span>
ymax <span class="o">&lt;-</span> <span class="kp">max</span><span class="p">(</span>dfw.long<span class="o">$</span>value<span class="p">)</span>
ymin <span class="o">&lt;-</span> <span class="kp">min</span><span class="p">(</span>dfw.long<span class="o">$</span>value<span class="p">)</span>

<span class="c1"># Plot the individuals</span>
ggplot<span class="p">(</span>dfw.long<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>condition<span class="p">,</span> y<span class="o">=</span>value<span class="p">,</span> colour<span class="o">=</span>subject<span class="p">,</span> group<span class="o">=</span>subject<span class="p">))</span> <span class="o">+</span>
    geom_line<span class="p">()</span> <span class="o">+</span> geom_point<span class="p">(</span>shape<span class="o">=</span><span class="m">21</span><span class="p">,</span> fill<span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)</span> <span class="o">+</span> 
    ylim<span class="p">(</span>ymin<span class="p">,</span>ymax<span class="p">)</span>


<span class="c1"># Create the normed version of the data</span>
dfwNorm.long <span class="o">&lt;-</span> normDataWithin<span class="p">(</span>data<span class="o">=</span>dfw.long<span class="p">,</span> idvar<span class="o">=</span><span class="s">&quot;subject&quot;</span><span class="p">,</span> measurevar<span class="o">=</span><span class="s">&quot;value&quot;</span><span class="p">)</span>

<span class="c1"># Plot the normed individuals</span>
ggplot<span class="p">(</span>dfwNorm.long<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>condition<span class="p">,</span> y<span class="o">=</span>value_norm<span class="p">,</span> colour<span class="o">=</span>subject<span class="p">,</span> group<span class="o">=</span>subject<span class="p">))</span> <span class="o">+</span>
    geom_line<span class="p">()</span> <span class="o">+</span> geom_point<span class="p">(</span>shape<span class="o">=</span><span class="m">21</span><span class="p">,</span> fill<span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)</span> <span class="o">+</span> 
    ylim<span class="p">(</span>ymin<span class="p">,</span>ymax<span class="p">)</span>
</pre></div>


<p><img alt="" src="Plotting_means_and_error_bars_(ggplot2)/within-individual.png" />
<img alt="" src="Plotting_means_and_error_bars_(ggplot2)/within-individual-normed.png" /></p>
<p>The differences in the error bars for the regular (between-subject) method and the within-subject method are shown here. The regular error bars are in red, and the within-subject error bars are in black.</p>
<div class="codehilite"><pre><span class="c1"># Instead of summarySEwithin, use summarySE, which treats condition as though it were a between-subjects variable</span>
dfwc.between <span class="o">&lt;-</span> summarySE<span class="p">(</span>data<span class="o">=</span>dfw.long<span class="p">,</span> measurevar<span class="o">=</span><span class="s">&quot;value&quot;</span><span class="p">,</span> groupvars<span class="o">=</span><span class="s">&quot;condition&quot;</span><span class="p">,</span> na.rm<span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> conf.interval<span class="o">=</span><span class="m">.95</span><span class="p">)</span>
<span class="c1"># condition  N value       sd       se       ci</span>
<span class="c1">#   pretest 10 47.74 8.598992 2.719240 6.151348</span>
<span class="c1">#  posttest 10 51.43 7.253972 2.293907 5.189179</span>

<span class="c1"># Show the between-S CI&#39;s in red, and the within-S CI&#39;s in black</span>
ggplot<span class="p">(</span>dfwc.between<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>condition<span class="p">,</span> y<span class="o">=</span>value<span class="p">,</span> group<span class="o">=</span><span class="m">1</span><span class="p">))</span> <span class="o">+</span>
    geom_line<span class="p">()</span> <span class="o">+</span>
    geom_errorbar<span class="p">(</span>width<span class="o">=</span><span class="m">.1</span><span class="p">,</span> aes<span class="p">(</span>ymin<span class="o">=</span>value<span class="o">-</span>ci<span class="p">,</span> ymax<span class="o">=</span>value<span class="o">+</span>ci<span class="p">),</span> colour<span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">)</span> <span class="o">+</span>
    geom_errorbar<span class="p">(</span>width<span class="o">=</span><span class="m">.1</span><span class="p">,</span> aes<span class="p">(</span>ymin<span class="o">=</span>value<span class="o">-</span>ci<span class="p">,</span> ymax<span class="o">=</span>value<span class="o">+</span>ci<span class="p">),</span> data<span class="o">=</span>dfwc<span class="p">)</span> <span class="o">+</span>
    geom_point<span class="p">(</span>shape<span class="o">=</span><span class="m">21</span><span class="p">,</span> size<span class="o">=</span><span class="m">3</span><span class="p">,</span> fill<span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">)</span> <span class="o">+</span>
    ylim<span class="p">(</span>ymin<span class="p">,</span>ymax<span class="p">)</span>
</pre></div>


<p><img alt="" src="Plotting_means_and_error_bars_(ggplot2)/within-compare-errorbars.png" /></p>
<h4 id="two-within-subjects-variables">Two within-subjects variables</h4>
<p>If there is more than one within-subjects variable, the same function, <code>summarySEwithin</code>, can be used. This data set is taken from <a href="http://books.google.com/books?id=zSi2AAAAIAAJ">Hays (1994)</a>, and used for making this type of within-subject error bar in <a href="http://www.jstor.org/pss/40064075">Rouder and Morey (2005)</a>.</p>
<div class="codehilite"><pre>data <span class="o">&lt;-</span> read.table<span class="p">(</span>header<span class="o">=</span><span class="bp">T</span><span class="p">,</span> text<span class="o">=</span><span class="s">&#39;</span>
<span class="s"> Subject RoundMono SquareMono RoundColor SquareColor</span>
<span class="s">       1        41         40         41          37</span>
<span class="s">       2        57         56         56          53</span>
<span class="s">       3        52         53         53          50</span>
<span class="s">       4        49         47         47          47</span>
<span class="s">       5        47         48         48          47</span>
<span class="s">       6        37         34         35          36</span>
<span class="s">       7        47         50         47          46</span>
<span class="s">       8        41         40         38          40</span>
<span class="s">       9        48         47         49          45</span>
<span class="s">      10        37         35         36          35</span>
<span class="s">      11        32         31         31          33</span>
<span class="s">      12        47         42         42          42</span>
<span class="s">&#39;</span><span class="p">)</span>
</pre></div>


<p>The data must first be converted to long format. In this case, the column names indicate two variables, shape (round/square) and color scheme (monochromatic/colored).</p>
<div class="codehilite"><pre><span class="c1"># Convert it to long format</span>
<span class="kn">library</span><span class="p">(</span>reshape2<span class="p">)</span>
data.long <span class="o">&lt;-</span> melt<span class="p">(</span>data<span class="o">=</span>data<span class="p">,</span> id.var<span class="o">=</span><span class="s">&quot;Subject&quot;</span><span class="p">,</span>
                  measure.vars<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;RoundMono&quot;</span><span class="p">,</span> <span class="s">&quot;SquareMono&quot;</span><span class="p">,</span> <span class="s">&quot;RoundColor&quot;</span><span class="p">,</span> <span class="s">&quot;SquareColor&quot;</span><span class="p">),</span>
                  variable.name<span class="o">=</span><span class="s">&quot;Condition&quot;</span><span class="p">)</span>
<span class="kp">names</span><span class="p">(</span>data.long<span class="p">)[</span><span class="kp">names</span><span class="p">(</span>data.long<span class="p">)</span><span class="o">==</span><span class="s">&quot;value&quot;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s">&quot;Time&quot;</span>

<span class="c1"># Split Condition column into Shape and ColorScheme</span>
data.long<span class="o">$</span>Shape <span class="o">&lt;-</span> <span class="kc">NA</span>
data.long<span class="o">$</span>Shape<span class="p">[</span><span class="kp">grepl</span><span class="p">(</span><span class="s">&quot;^Round&quot;</span><span class="p">,</span>  data.long<span class="o">$</span>Condition<span class="p">)]</span> <span class="o">&lt;-</span> <span class="s">&quot;Round&quot;</span>
data.long<span class="o">$</span>Shape<span class="p">[</span><span class="kp">grepl</span><span class="p">(</span><span class="s">&quot;^Square&quot;</span><span class="p">,</span> data.long<span class="o">$</span>Condition<span class="p">)]</span> <span class="o">&lt;-</span> <span class="s">&quot;Square&quot;</span>
data.long<span class="o">$</span>Shape <span class="o">&lt;-</span> <span class="kp">factor</span><span class="p">(</span>data.long<span class="o">$</span>Shape<span class="p">)</span>

data.long<span class="o">$</span>ColorScheme <span class="o">&lt;-</span> <span class="kc">NA</span>
data.long<span class="o">$</span>ColorScheme<span class="p">[</span><span class="kp">grepl</span><span class="p">(</span><span class="s">&quot;Mono$&quot;</span><span class="p">,</span>  data.long<span class="o">$</span>Condition<span class="p">)]</span> <span class="o">&lt;-</span> <span class="s">&quot;Monochromatic&quot;</span>
data.long<span class="o">$</span>ColorScheme<span class="p">[</span><span class="kp">grepl</span><span class="p">(</span><span class="s">&quot;Color$&quot;</span><span class="p">,</span> data.long<span class="o">$</span>Condition<span class="p">)]</span> <span class="o">&lt;-</span> <span class="s">&quot;Colored&quot;</span>
data.long<span class="o">$</span>ColorScheme <span class="o">&lt;-</span> <span class="kp">factor</span><span class="p">(</span>data.long<span class="o">$</span>ColorScheme<span class="p">,</span> levels<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;Monochromatic&quot;</span><span class="p">,</span><span class="s">&quot;Colored&quot;</span><span class="p">))</span>

<span class="c1"># Remove the Condition column now</span>
data.long<span class="o">$</span>Condition <span class="o">&lt;-</span> <span class="kc">NULL</span>

data.long
<span class="c1"># Subject Time  Shape   ColorScheme</span>
<span class="c1">#       1   41  Round Monochromatic</span>
<span class="c1">#       2   57  Round Monochromatic</span>
<span class="c1">#       3   52  Round Monochromatic</span>
<span class="c1">#   ...</span>
<span class="c1">#       1   37 Square       Colored</span>
<span class="c1">#       2   53 Square       Colored</span>
<span class="c1">#   ...</span>
<span class="c1">#      11   33 Square       Colored</span>
<span class="c1">#      12   42 Square       Colored</span>
</pre></div>


<p>Now it can be summarized and graphed.</p>
<div class="codehilite"><pre>datac <span class="o">&lt;-</span> summarySEwithin<span class="p">(</span>data.long<span class="p">,</span> measurevar<span class="o">=</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> withinvars<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;Shape&quot;</span><span class="p">,</span><span class="s">&quot;ColorScheme&quot;</span><span class="p">),</span> idvar<span class="o">=</span><span class="s">&quot;Subject&quot;</span><span class="p">)</span>
<span class="c1">#  Shape   ColorScheme  N     Time Time_norm       sd        se        ci</span>
<span class="c1">#  Round       Colored 12 43.58333  43.58333 1.212311 0.3499639 0.7702654</span>
<span class="c1">#  Round Monochromatic 12 44.58333  44.58333 1.331438 0.3843531 0.8459554</span>
<span class="c1"># Square       Colored 12 42.58333  42.58333 1.461630 0.4219364 0.9286757</span>
<span class="c1"># Square Monochromatic 12 43.58333  43.58333 1.261312 0.3641095 0.8013997</span>

<span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
ggplot<span class="p">(</span>datac<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>Shape<span class="p">,</span> y<span class="o">=</span>Time<span class="p">,</span> fill<span class="o">=</span>ColorScheme<span class="p">))</span> <span class="o">+</span>
    geom_bar<span class="p">(</span>position<span class="o">=</span>position_dodge<span class="p">(</span><span class="m">.9</span><span class="p">),</span> colour<span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span> stat<span class="o">=</span><span class="s">&quot;identity&quot;</span><span class="p">)</span> <span class="o">+</span>
    geom_errorbar<span class="p">(</span>position<span class="o">=</span>position_dodge<span class="p">(</span><span class="m">.9</span><span class="p">),</span> width<span class="o">=</span><span class="m">.25</span><span class="p">,</span> aes<span class="p">(</span>ymin<span class="o">=</span>Time<span class="o">-</span>ci<span class="p">,</span> ymax<span class="o">=</span>Time<span class="o">+</span>ci<span class="p">))</span> <span class="o">+</span>
    coord_cartesian<span class="p">(</span>ylim<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">40</span><span class="p">,</span><span class="m">46</span><span class="p">))</span> <span class="o">+</span>
    scale_fill_manual<span class="p">(</span>values<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;#CCCCCC&quot;</span><span class="p">,</span><span class="s">&quot;#FFFFFF&quot;</span><span class="p">))</span> <span class="o">+</span>
    scale_y_continuous<span class="p">(</span>breaks<span class="o">=</span><span class="kp">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="p">))</span> <span class="o">+</span>
    theme_bw<span class="p">()</span> <span class="o">+</span>
    geom_hline<span class="p">(</span>yintercept<span class="o">=</span><span class="m">38</span><span class="p">)</span> 
</pre></div>


<p><img alt="" src="Plotting_means_and_error_bars_(ggplot2)/within-within-errorbars.png" /></p>
<h3 id="note-about-normed-means">Note about normed means</h3>
<p>The <code>summarySEWithin</code> function returns both normed and un-normed means. The un-normed means are simply the mean of each group. The normed means are calculated so that means of each between-subject group are the same. These values can diverge when there are between-subject variables.</p>
<p>For example:</p>
<div class="codehilite"><pre>dat <span class="o">&lt;-</span> read.table<span class="p">(</span>header<span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> text<span class="o">=</span><span class="s">&#39;</span>
<span class="s">id trial gender dv</span>
<span class="s"> A     0   male  2</span>
<span class="s"> A     1   male  4</span>
<span class="s"> B     0   male  6</span>
<span class="s"> B     1   male  8</span>
<span class="s"> C     0 female 22</span>
<span class="s"> C     1 female 24</span>
<span class="s"> D     0 female 26</span>
<span class="s"> D     1 female 28</span>
<span class="s">&#39;</span><span class="p">)</span>

<span class="c1"># normed and un-normed means are different</span>
summarySEwithin<span class="p">(</span>dat<span class="p">,</span> measurevar<span class="o">=</span><span class="s">&quot;dv&quot;</span><span class="p">,</span> withinvars<span class="o">=</span><span class="s">&quot;trial&quot;</span><span class="p">,</span> betweenvars<span class="o">=</span><span class="s">&quot;gender&quot;</span><span class="p">,</span>
                idvar<span class="o">=</span><span class="s">&quot;id&quot;</span><span class="p">)</span>
<span class="c1"># gender trial N dv dv_norm sd se ci</span>
<span class="c1"># female     0 2 24      14  0  0  0</span>
<span class="c1"># female     1 2 26      16  0  0  0</span>
<span class="c1">#   male     0 2  4      14  0  0  0</span>
<span class="c1">#   male     1 2  6      16  0  0  0</span>
</pre></div>


<h3 id="helper-functions">Helper functions</h3>
<p>The <code>summarySE</code> function is also defined on <a href="../Manipulating_data/Converting_data_between_wide_and_long_format.html">this page</a>. If you only are working with between-subjects variables, that is the only function you will need in your code. If you have within-subjects variables <strong><em>and</em></strong> want to adjust the error bars so that inter-subject variability is removed as in Loftus and Masson (1994), then the other two functions, <code>normDataWithin</code> and <code>summarySEwithin</code> must also be added to your code; <code>summarySEwithin</code> will then be the function that you call.</p>
<div class="codehilite"><pre><span class="c1">## Summarizes data.</span>
<span class="c1">## Gives count, mean, standard deviation, standard error of the mean, and confidence interval (default 95%).</span>
<span class="c1">##   data: a data frame.</span>
<span class="c1">##   measurevar: the name of a column that contains the variable to be summariezed</span>
<span class="c1">##   groupvars: a vector containing names of columns that contain grouping variables</span>
<span class="c1">##   na.rm: a boolean that indicates whether to ignore NA&#39;s</span>
<span class="c1">##   conf.interval: the percent range of the confidence interval (default is 95%)</span>
summarySE <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>data<span class="o">=</span><span class="kc">NULL</span><span class="p">,</span> measurevar<span class="p">,</span> groupvars<span class="o">=</span><span class="kc">NULL</span><span class="p">,</span> na.rm<span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span>
                      conf.interval<span class="o">=</span><span class="m">.95</span><span class="p">,</span> <span class="m">.</span>drop<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="kn">require</span><span class="p">(</span>plyr<span class="p">)</span>

    <span class="c1"># New version of length which can handle NA&#39;s: if na.rm==T, don&#39;t count them</span>
    length2 <span class="o">&lt;-</span> <span class="kr">function</span> <span class="p">(</span>x<span class="p">,</span> na.rm<span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">if</span> <span class="p">(</span>na.rm<span class="p">)</span> <span class="kp">sum</span><span class="p">(</span><span class="o">!</span><span class="kp">is.na</span><span class="p">(</span>x<span class="p">))</span>
        <span class="kr">else</span>       <span class="kp">length</span><span class="p">(</span>x<span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># This does the summary. For each group&#39;s data frame, return a vector with</span>
    <span class="c1"># N, mean, and sd</span>
    datac <span class="o">&lt;-</span> ddply<span class="p">(</span>data<span class="p">,</span> groupvars<span class="p">,</span> <span class="m">.</span>drop<span class="o">=</span><span class="m">.</span><span class="kp">drop</span><span class="p">,</span>
      <span class="m">.</span>fun <span class="o">=</span> <span class="kr">function</span><span class="p">(</span>xx<span class="p">,</span> <span class="kp">col</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">c</span><span class="p">(</span>N    <span class="o">=</span> length2<span class="p">(</span>xx<span class="p">[[</span><span class="kp">col</span><span class="p">]],</span> na.rm<span class="o">=</span>na.rm<span class="p">),</span>
          mean <span class="o">=</span> mean   <span class="p">(</span>xx<span class="p">[[</span><span class="kp">col</span><span class="p">]],</span> na.rm<span class="o">=</span>na.rm<span class="p">),</span>
          sd   <span class="o">=</span> sd     <span class="p">(</span>xx<span class="p">[[</span><span class="kp">col</span><span class="p">]],</span> na.rm<span class="o">=</span>na.rm<span class="p">)</span>
        <span class="p">)</span>
      <span class="p">},</span>
      measurevar
    <span class="p">)</span>

    <span class="c1"># Rename the &quot;mean&quot; column    </span>
    datac <span class="o">&lt;-</span> rename<span class="p">(</span>datac<span class="p">,</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;mean&quot;</span> <span class="o">=</span> measurevar<span class="p">))</span>

    datac<span class="o">$</span>se <span class="o">&lt;-</span> datac<span class="o">$</span>sd <span class="o">/</span> <span class="kp">sqrt</span><span class="p">(</span>datac<span class="o">$</span>N<span class="p">)</span>  <span class="c1"># Calculate standard error of the mean</span>

    <span class="c1"># Confidence interval multiplier for standard error</span>
    <span class="c1"># Calculate t-statistic for confidence interval: </span>
    <span class="c1"># e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1</span>
    ciMult <span class="o">&lt;-</span> qt<span class="p">(</span>conf.interval<span class="o">/</span><span class="m">2</span> <span class="o">+</span> <span class="m">.5</span><span class="p">,</span> datac<span class="o">$</span>N<span class="m">-1</span><span class="p">)</span>
    datac<span class="o">$</span>ci <span class="o">&lt;-</span> datac<span class="o">$</span>se <span class="o">*</span> ciMult

    <span class="kr">return</span><span class="p">(</span>datac<span class="p">)</span>
<span class="p">}</span>
</pre></div>


<div class="codehilite"><pre><span class="c1">## Norms the data within specified groups in a data frame; it normalizes each</span>
<span class="c1">## subject (identified by idvar) so that they have the same mean, within each group</span>
<span class="c1">## specified by betweenvars.</span>
<span class="c1">##   data: a data frame.</span>
<span class="c1">##   idvar: the name of a column that identifies each subject (or matched subjects)</span>
<span class="c1">##   measurevar: the name of a column that contains the variable to be summariezed</span>
<span class="c1">##   betweenvars: a vector containing names of columns that are between-subjects variables</span>
<span class="c1">##   na.rm: a boolean that indicates whether to ignore NA&#39;s</span>
normDataWithin <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>data<span class="o">=</span><span class="kc">NULL</span><span class="p">,</span> idvar<span class="p">,</span> measurevar<span class="p">,</span> betweenvars<span class="o">=</span><span class="kc">NULL</span><span class="p">,</span>
                           na.rm<span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="m">.</span>drop<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="kn">require</span><span class="p">(</span>plyr<span class="p">)</span>

    <span class="c1"># Measure var on left, idvar + between vars on right of formula.</span>
    data.subjMean <span class="o">&lt;-</span> ddply<span class="p">(</span>data<span class="p">,</span> <span class="kt">c</span><span class="p">(</span>idvar<span class="p">,</span> betweenvars<span class="p">),</span> <span class="m">.</span>drop<span class="o">=</span><span class="m">.</span><span class="kp">drop</span><span class="p">,</span>
     <span class="m">.</span>fun <span class="o">=</span> <span class="kr">function</span><span class="p">(</span>xx<span class="p">,</span> <span class="kp">col</span><span class="p">,</span> na.rm<span class="p">)</span> <span class="p">{</span>
        <span class="kt">c</span><span class="p">(</span>subjMean <span class="o">=</span> <span class="kp">mean</span><span class="p">(</span>xx<span class="p">[,</span><span class="kp">col</span><span class="p">],</span> na.rm<span class="o">=</span>na.rm<span class="p">))</span>
      <span class="p">},</span>
      measurevar<span class="p">,</span>
      na.rm
    <span class="p">)</span>

    <span class="c1"># Put the subject means with original data</span>
    data <span class="o">&lt;-</span> <span class="kp">merge</span><span class="p">(</span>data<span class="p">,</span> data.subjMean<span class="p">)</span>

    <span class="c1"># Get the normalized data in a new column</span>
    measureNormedVar <span class="o">&lt;-</span> <span class="kp">paste</span><span class="p">(</span>measurevar<span class="p">,</span> <span class="s">&quot;_norm&quot;</span><span class="p">,</span> sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    data<span class="p">[,</span>measureNormedVar<span class="p">]</span> <span class="o">&lt;-</span> data<span class="p">[,</span>measurevar<span class="p">]</span> <span class="o">-</span> data<span class="p">[,</span><span class="s">&quot;subjMean&quot;</span><span class="p">]</span> <span class="o">+</span>
                               <span class="kp">mean</span><span class="p">(</span>data<span class="p">[,</span>measurevar<span class="p">],</span> na.rm<span class="o">=</span>na.rm<span class="p">)</span>

    <span class="c1"># Remove this subject mean column</span>
    data<span class="o">$</span>subjMean <span class="o">&lt;-</span> <span class="kc">NULL</span>

    <span class="kr">return</span><span class="p">(</span>data<span class="p">)</span>
<span class="p">}</span>
</pre></div>


<div class="codehilite"><pre><span class="c1">## Summarizes data, handling within-subjects variables by removing inter-subject variability.</span>
<span class="c1">## It will still work if there are no within-S variables.</span>
<span class="c1">## Gives count, un-normed mean, normed mean (with same between-group mean),</span>
<span class="c1">##   standard deviation, standard error of the mean, and confidence interval.</span>
<span class="c1">## If there are within-subject variables, calculate adjusted values using method from Morey (2008).</span>
<span class="c1">##   data: a data frame.</span>
<span class="c1">##   measurevar: the name of a column that contains the variable to be summariezed</span>
<span class="c1">##   betweenvars: a vector containing names of columns that are between-subjects variables</span>
<span class="c1">##   withinvars: a vector containing names of columns that are within-subjects variables</span>
<span class="c1">##   idvar: the name of a column that identifies each subject (or matched subjects)</span>
<span class="c1">##   na.rm: a boolean that indicates whether to ignore NA&#39;s</span>
<span class="c1">##   conf.interval: the percent range of the confidence interval (default is 95%)</span>
summarySEwithin <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>data<span class="o">=</span><span class="kc">NULL</span><span class="p">,</span> measurevar<span class="p">,</span> betweenvars<span class="o">=</span><span class="kc">NULL</span><span class="p">,</span> withinvars<span class="o">=</span><span class="kc">NULL</span><span class="p">,</span>
                            idvar<span class="o">=</span><span class="kc">NULL</span><span class="p">,</span> na.rm<span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> conf.interval<span class="o">=</span><span class="m">.95</span><span class="p">,</span> <span class="m">.</span>drop<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1"># Ensure that the betweenvars and withinvars are factors</span>
  factorvars <span class="o">&lt;-</span> <span class="kp">vapply</span><span class="p">(</span>data<span class="p">[,</span> <span class="kt">c</span><span class="p">(</span>betweenvars<span class="p">,</span> withinvars<span class="p">),</span> drop<span class="o">=</span><span class="kc">FALSE</span><span class="p">],</span>
    FUN<span class="o">=</span><span class="kp">is.factor</span><span class="p">,</span> FUN.VALUE<span class="o">=</span><span class="kt">logical</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>

  <span class="kr">if</span> <span class="p">(</span><span class="o">!</span><span class="kp">all</span><span class="p">(</span>factorvars<span class="p">))</span> <span class="p">{</span>
    nonfactorvars <span class="o">&lt;-</span> <span class="kp">names</span><span class="p">(</span>factorvars<span class="p">)[</span><span class="o">!</span>factorvars<span class="p">]</span>
    <span class="kp">message</span><span class="p">(</span><span class="s">&quot;Automatically converting the following non-factors to factors: &quot;</span><span class="p">,</span>
            <span class="kp">paste</span><span class="p">(</span>nonfactorvars<span class="p">,</span> collapse <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="p">))</span>
    data<span class="p">[</span>nonfactorvars<span class="p">]</span> <span class="o">&lt;-</span> <span class="kp">lapply</span><span class="p">(</span>data<span class="p">[</span>nonfactorvars<span class="p">],</span> <span class="kp">factor</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1"># Get the means from the un-normed data</span>
  datac <span class="o">&lt;-</span> summarySE<span class="p">(</span>data<span class="p">,</span> measurevar<span class="p">,</span> groupvars<span class="o">=</span><span class="kt">c</span><span class="p">(</span>betweenvars<span class="p">,</span> withinvars<span class="p">),</span>
                     na.rm<span class="o">=</span>na.rm<span class="p">,</span> conf.interval<span class="o">=</span>conf.interval<span class="p">,</span> <span class="m">.</span>drop<span class="o">=</span><span class="m">.</span><span class="kp">drop</span><span class="p">)</span>

  <span class="c1"># Drop all the unused columns (these will be calculated with normed data)</span>
  datac<span class="o">$</span>sd <span class="o">&lt;-</span> <span class="kc">NULL</span>
  datac<span class="o">$</span>se <span class="o">&lt;-</span> <span class="kc">NULL</span>
  datac<span class="o">$</span>ci <span class="o">&lt;-</span> <span class="kc">NULL</span>

  <span class="c1"># Norm each subject&#39;s data</span>
  ndata <span class="o">&lt;-</span> normDataWithin<span class="p">(</span>data<span class="p">,</span> idvar<span class="p">,</span> measurevar<span class="p">,</span> betweenvars<span class="p">,</span> na.rm<span class="p">,</span> <span class="m">.</span>drop<span class="o">=</span><span class="m">.</span><span class="kp">drop</span><span class="p">)</span>

  <span class="c1"># This is the name of the new column</span>
  measurevar_n <span class="o">&lt;-</span> <span class="kp">paste</span><span class="p">(</span>measurevar<span class="p">,</span> <span class="s">&quot;_norm&quot;</span><span class="p">,</span> sep<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>

  <span class="c1"># Collapse the normed data - now we can treat between and within vars the same</span>
  ndatac <span class="o">&lt;-</span> summarySE<span class="p">(</span>ndata<span class="p">,</span> measurevar_n<span class="p">,</span> groupvars<span class="o">=</span><span class="kt">c</span><span class="p">(</span>betweenvars<span class="p">,</span> withinvars<span class="p">),</span>
                      na.rm<span class="o">=</span>na.rm<span class="p">,</span> conf.interval<span class="o">=</span>conf.interval<span class="p">,</span> <span class="m">.</span>drop<span class="o">=</span><span class="m">.</span><span class="kp">drop</span><span class="p">)</span>

  <span class="c1"># Apply correction from Morey (2008) to the standard error and confidence interval</span>
  <span class="c1">#  Get the product of the number of conditions of within-S variables</span>
  nWithinGroups    <span class="o">&lt;-</span> <span class="kp">prod</span><span class="p">(</span><span class="kp">vapply</span><span class="p">(</span>ndatac<span class="p">[,</span>withinvars<span class="p">,</span> drop<span class="o">=</span><span class="kc">FALSE</span><span class="p">],</span> FUN<span class="o">=</span><span class="kp">nlevels</span><span class="p">,</span>
                           FUN.VALUE<span class="o">=</span><span class="kt">numeric</span><span class="p">(</span><span class="m">1</span><span class="p">)))</span>
  correctionFactor <span class="o">&lt;-</span> <span class="kp">sqrt</span><span class="p">(</span> nWithinGroups <span class="o">/</span> <span class="p">(</span>nWithinGroups<span class="m">-1</span><span class="p">)</span> <span class="p">)</span>

  <span class="c1"># Apply the correction factor</span>
  ndatac<span class="o">$</span>sd <span class="o">&lt;-</span> ndatac<span class="o">$</span>sd <span class="o">*</span> correctionFactor
  ndatac<span class="o">$</span>se <span class="o">&lt;-</span> ndatac<span class="o">$</span>se <span class="o">*</span> correctionFactor
  ndatac<span class="o">$</span>ci <span class="o">&lt;-</span> ndatac<span class="o">$</span>ci <span class="o">*</span> correctionFactor

  <span class="c1"># Combine the un-normed means with the normed results</span>
  <span class="kp">merge</span><span class="p">(</span>datac<span class="p">,</span> ndatac<span class="p">)</span>
<span class="p">}</span>
</pre></div>
        
        
        
        
        <hr class="clear" />
      </div> <!-- div#content -->
      
      
      <div id="footer">
        <p>
          
            Cookbook for R â
          
          Powered by <a href="http://markdoc.org/">Markdoc</a>.
          Please report errors to winston@stdout.org.
        </p>
      </div>
      
    
    
    
    <hr class="clear" />

  
    
      <!-- Google Analytics -->
      <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-28886507-2']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
        })();
      </script>
    
  

  </body>
</html>